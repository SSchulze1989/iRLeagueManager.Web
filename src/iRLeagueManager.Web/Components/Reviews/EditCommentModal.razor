@using iRLeagueApiCore.Common.Enums
@using iRLeagueApiCore.Common.Models
@using iRLeagueApiCore.Common.Models.Results;
@using iRLeagueApiCore.Common.Models.Reviews
@using iRLeagueManager.Web.ViewModels
@inherits EditMudModalBase<ReviewCommentViewModel, ReviewCommentModel>
@inject LeagueApiService ApiService

<EditForm Model=Vm OnValidSubmit=Submit>
    <MudDialog>
        <DialogContent>
            <MudTextField Label="Text" FullWidth="true" Lines="6" @bind-Value="Vm.Text" Variant="Variant.Filled"/>
            @foreach(var vote in Vm.Votes)
            {
                 <MudGrid Spacing="1" Style="width: 100%">
                    <MudItem xs="5">
                        <MudSelect Label="Vote" @bind-Value="vote.VoteCategoryId" Variant="Variant.Filled">
                            @foreach (var cat in AvailableVoteCategories)
                            {
                                <MudSelectItem Value=@((long?)cat.Id)>@cat.Text</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6">
                        <MudSelect Label="Driver at fault" 
                                   @bind-Value="vote.MemberAtFault" 
                                   Variant="Variant.Filled" 
                                   ToStringFunc="@(member => member != null ? $"{member.FirstName} {member.LastName}" : string.Empty)">
                            <MudSelectItem Value="default(MemberInfoModel)"></MudSelectItem>
                            @foreach (var member in InvolvedMembers)
                            {
                                <MudSelectItem Value="@member" />
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="1" Class="d-flex align-center">
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" Color="Color.Error" OnClick="@(() => Vm.RemoveVote(vote))"/>
                    </MudItem>
                </MudGrid>
            }
            <MudGrid Spacing="1" Style="width: 100%">
                <MudItem xs="5">
                    <MudSelect Label="Vote" @bind-Value="NewValue" Variant="Variant.Filled" @ref=@NewValueInput>
                        @foreach (var cat in AvailableVoteCategories)
                        {
                            <MudSelectItem Value=@((long?)cat.Id)>@cat.Text</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </DialogContent>
        <DialogActions>
            <MudButton Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
            <MudButton Color="Color.Primary" OnClick="Submit">Submit</MudButton>
        </DialogActions>
    </MudDialog>
</EditForm>

@code {
    [Parameter]
    public IEnumerable<MemberInfoModel> InvolvedMembers { get; set; } = Array.Empty<MemberInfoModel>();

    private long? NewValue
    {
        get => default;
        set
        {
            if(value is not null)
            {
                _ = SetNewValue(value);
            }
        }
    }

    private MudSelect<long?> NewValueInput { get; set; } = default!;

    private IEnumerable<VoteCategoryModel> AvailableVoteCategories = Array.Empty<VoteCategoryModel>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender == false)
        {
            return;
        }
        AvailableVoteCategories = await GetAvailableVoteCategories();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SetNewValue(long? value)
    {
        var voteCat = AvailableVoteCategories.FirstOrDefault(x => x.Id == value);
        if (voteCat is not null)
        {
            var vote = new VoteModel()
            {
                VoteCategoryId = voteCat.Id,
                VoteCategoryText = voteCat.Text,
            };
            Vm.AddVote(vote);
        }
        await NewValueInput.FocusAsync();
    }

    private void SetMemberAtFault(VoteViewModel vote, long? memberId)
    {
        var member = InvolvedCars
            .Select(x => x.Members.FirstOrDefault())
            .NotNull()
            .FirstOrDefault(x => x.MemberId == memberId);

        if (memberId is null || member is null)
        {
            vote.MemberAtFault = null;
            return;
        }
        vote.MemberAtFault = new MemberInfoModel()
        {
            MemberId = memberId.Value,
            FirstName = member.FirstName,
            LastName = member.LastName,
        };
    }

    private async Task<IEnumerable<VoteCategoryModel>> GetAvailableVoteCategories()
    {
        if (ApiService.CurrentLeague is null)
        {
            return Array.Empty<VoteCategoryModel>();
        }

        var request = ApiService.CurrentLeague
            .VoteCategories()
            .Get();
        var result = await request;
        if (result.Success && result.Content is IEnumerable<VoteCategoryModel> models)
        {
            return models;
        }
        return Array.Empty<VoteCategoryModel>();
    }
}
