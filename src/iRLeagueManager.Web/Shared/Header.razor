@inherits LeagueComponentBase
@inject LeaguesViewModel Vm

<header class="page-header p-0">
    <nav class="navbar navbar-expand-lg navbar-dark p-1 pe-2 ps-2">
        <div class="container-fluid">
            <div class="navbar-brand d-flex align-items-center gap-2">
                <figure class="logo">
                    <img src="logo/iRLM_Logo_17_darkbg.png" />
                </figure>
                <label class="text-muted"> v@(VersionString)</label>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#headerNavbarContent" aria-controls="headerNavbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div id="headerNavbarContent" class="collapse navbar-collapse gap-5 justify-content-lg-between">
                <ul class="navbar-nav flex-lg-grow-1 gap-md-2">
                    <li class="nav-item">
                        <div class="btn-group">
                            <NavLink class="nav-link pe-0 d-none d-lg-block"
                                     type="button" 
                                     href="@($"/{CurrentLeagueTarget}")"
                                     Match="NavLinkMatch.Prefix">
                                @CurrentLeagueTarget
                            </NavLink>
                            <NavLink class="nav-link dropdown-toggle" type="button"
                                    id="navLeaguesDropdown"
                                    role="button"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    href="@($"/{CurrentLeagueTarget}")">
                                <span class="d-lg-none">@CurrentLeagueTarget</span>
                            </NavLink>
                            <ul class="dropdown-menu" aria-labelledby="navLeaguesDropdown">
                                @foreach(var league in Bind(Vm, x => x.Leagues))
                                {
                                    <li>
                                        <NavLink class="dropdown-item" href="@($"/{league.LeagueName}")" 
                                                 @onclick=@(() => ForceNavigateTo($"/{league.LeagueName}", fullReload: true))
                                                 Match="NavLinkMatch.Prefix">
                                            @league.LeagueName
                                        </NavLink>
                                    </li>
                                }
                            </ul>
                        </div>
                    </li>
                    @if (string.IsNullOrEmpty(Shared.LeagueName) == false)
                    {
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"./{Shared.LeagueName}/Schedules")"
                                 Match="NavLinkMatch.Prefix">
                                Schedule
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"./{Shared.LeagueName}/Results")"
                                     Match="NavLinkMatch.Prefix">
                                Results
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"./{Shared.LeagueName}/Standings")"
                                 Match="NavLinkMatch.Prefix">
                                Standings
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"./{Shared.LeagueName}/Reviews")"
                                 Match="NavLinkMatch.Prefix">
                                Reviews
                            </NavLink>
                        </li>
                    }
                    @if (string.IsNullOrEmpty(Shared.LeagueName) == false)
                    {
                        <li class="nav-item flex-fill">
                            <select @bind="SeasonSelect" class="form-select" style="max-width: 240px">
                                @foreach (var season in Shared.SeasonList)
                                {
                                    <option value="@season.SeasonId" class="nav-option">@season.SeasonName</option>
                                }
                            </select>
                        </li>
                    }
                </ul>
                <div class="navbar-nav gap-2 mt-2 mb-2">
                    <div class="d-flex gap-2 align-items-center">
                        <AuthorizeView Roles="@GetRoleString(LeagueRoles.Admin, LeagueRoles.Organizer)">
                            <Authorized>
                                <div class="nav-item">
                                    <NavLink class="nav-link" title="Settings" href="@($"./{Shared.LeagueName}/Settings")">
                                        <span class="oi oi-cog" />
                                    </NavLink>
                                </div>
                            </Authorized>
                        </AuthorizeView>
                         <AuthorizeView>
                            <Authorized>
                                <label class="d-none d-lg-block">@context.User.Identity?.Name</label>
                            </Authorized>
                        </AuthorizeView>
                        <div class="dropdown">
                            <button class="btn btn-outline-light" type="button" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Account">
                                <span class="oi oi-person" />
                            </button>
                            <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="userMenuDropdown">
                                <AuthorizeView>
                                    <Authorized>
                                        <li><NavLink class="dropdown-item" href="@($"/member/logout?returnUrl={GetReturnUrl()}")">Logout</NavLink></li>
                                    </Authorized>
                                    <NotAuthorized>
                                        <li><NavLink class="dropdown-item" href="@($"/member/login?returnUrl={GetReturnUrl()}")">Login</NavLink></li>
                                    </NotAuthorized>
                                </AuthorizeView>
                            </ul>
                        </div>
                        <AuthorizeView>
                            <Authorized>
                                <label class="d-lg-none">@context.User.Identity?.Name</label>
                            </Authorized>
                        </AuthorizeView>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>

@code {
    private static string VersionString { get; } = $"{System.Reflection.Assembly.GetEntryAssembly()!.GetName().Version!.Major}.{System.Reflection.Assembly.GetEntryAssembly()!.GetName().Version!.Minor}.{System.Reflection.Assembly.GetEntryAssembly()!.GetName().Version!.Build}";

    private string CurrentLeagueTarget => string.IsNullOrEmpty(Shared.LeagueName) ? "Leagues" : Shared.LeagueName;

    private string UserName => Shared.Username ?? string.Empty;

    private long SeasonSelect
    {
        get => Shared.SeasonId;
        set => _ = OnSeasonSelectChanged(value);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender == false)
        {
            return;
        }
        if (Vm.Leagues.Count > 0)
        {
            return;
        }
        await Vm.OnAfterRenderAsync(firstRender);
    }

    private async Task OnSeasonSelectChanged(long value)
    {
        if (Shared.LeagueName == null || value == 0)
        {
            return;
        }
        await ApiService.SetCurrentSeasonAsync(Shared.LeagueName, value);
        if (NavigationManager.Uri.Contains($"{Shared.LeagueName}/Results"))
        {
            ForceNavigateTo($"{Shared.LeagueName}/Results");
        }
        if (NavigationManager.Uri.Contains($"{Shared.LeagueName}/Schedules"))
        {
            ForceNavigateTo($"{Shared.LeagueName}/Schedules");
        }
        if (NavigationManager.Uri.Contains($"{Shared.LeagueName}/Standings"))
        {
            ForceNavigateTo($"{Shared.LeagueName}/Standings");
        }
        if (NavigationManager.Uri.Contains($"{Shared.LeagueName}/Reviews"))
        {
            ForceNavigateTo($"{Shared.LeagueName}/Reviews");
        }
        await InvokeAsync(StateHasChanged);
    }
}
